<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <title>網路輿情編排系統</title>
    <style>
		div {
		    min-height: 10px;
		    padding: 10px;
		    margin-bottom: 10px;
		    background-color: #f5f5f5;
		    border: 1px solid #e3e3e3;
		    -webkit-border-radius: 4px;
		    -moz-border-radius: 4px;
		    border-radius: 4px;
		    -webkit-box-shadow: inset 0 1px 1px rgb(0 0 0 / 5%);
		    -moz-box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.05);
		    box-shadow: inset 0 1px 1px rgb(0 0 0 / 5%);
		}
		table {
		    min-height: 10px;
		    padding: 10px;
		    margin-bottom: 10px;
		    background-color: #f5f5f5;
		    border: 1px solid #e3e3e3;
		    -webkit-border-radius: 4px;
		    -moz-border-radius: 4px;
		    border-radius: 4px;
		    -webkit-box-shadow: inset 0 1px 1px rgb(0 0 0 / 5%);
		    -moz-box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.05);
		    box-shadow: inset 0 1px 1px rgb(0 0 0 / 5%);
		}
		button{
			text-align: center;
			padding: 4px 14px;
			font-size: 14px;
			vertical-align: middle;
    		cursor: pointer;
		}


    </style>
  </head>
  <body>

	<button onclick="addNo()">編號</button>
	<button onclick="removeNo()">重新編號</button>

	<div id="main2" style="background-color: #000000" class="drag-sort-enable">
		<table >
		<tbody>
		  <tr>
		    <td><textarea name="post" maxlength="1000" cols="20" rows="4" style="width: 600px; height: 35px;"></textarea></td>
		    <td><button onclick="upward(this)">上移</button><button onclick="downward(this)">下移</button><button onclick="addPost(this)">新增</button><button onclick="removePost(this)">刪除</button></td>
		  </tr>
		</tbody> 
		</table>
		<table>
		<tbody>
		  <tr>
		    <td><textarea name="post" maxlength="1000" cols="20" rows="4" style="width: 600px; height: 35px;"></textarea></td>
		    <td><button onclick="upward(this)">上移</button><button onclick="downward(this)">下移</button><button onclick="addPost(this)">新增</button><button onclick="removePost(this)">刪除</button></td>
		  </tr>
		</tbody>
		</table>
		
	</div>
	<button onclick="addCategory()">新增主題</button><button onclick="removeCategory()">減少主題</button>
	<button onclick="sortall()">整合</button><br>
	<textarea id="finallcontent" style="width: 600px"></textarea>>

    <script>
    	function sortall(){
    		var text = document.getElementById("finallcontent");
    		text.value = "";
			var allOut = document.querySelectorAll('table');
			for (let o = 0; o < allOut.length; o++) {
			    var outSec = document.getElementsByTagName("table")[o];
			    var outNo = [].indexOf.call(allOut , outSec );
			    for (let i = 0; i < outSec.rows.length; i++) {
			        var inSec = outSec.rows[i].cells[0].lastChild;
			        if(inSec.tagName=="TEXTAREA" && inSec.value!=""){
			            text.value = text.value+ inSec.value+"\n\n";

			            var adjustedHeight=text.clientHeight;			            
			            adjustedHeight=Math.max(text.scrollHeight,adjustedHeight);
			            if (adjustedHeight>text.clientHeight){
			            	text.style.height=adjustedHeight+'px';
			            }         
			        }
			    }
			}    		
    	}

    	function addCategory(){
		    //num 取得table的現有欄位數+1(從0開始計算)
		    var thisTable = document.createElement("table");
		    // Tr 的 .insertRow 就是在 table 欄位中新增一個 Row num 表示新增在最後一筆
		    var Tr = thisTable.insertRow(0);
		    // Td 的.insertCell 在 Tr中新增一個 td Tr.cells.length 在Tr中 Td最後欄位新增一個Td 
		    Td1 = Tr.insertCell(Tr.cells.length);
		    Td2 = Tr.insertCell(Tr.cells.length);
		    Td1.innerHTML='<textarea name="post" maxlength="1000" cols="20" rows="4" style="width: 600px; height: 35px;"></textarea>';
		    Td2.innerHTML='<button onclick="upward(this)">上移</button><button onclick="downward(this)">下移</button><button onclick="addPost(this)">新增</button><button onclick="removePost(this)">刪除</button>';
		    var div = document.getElementById("main2");
		    div.appendChild(thisTable); //appendChild
		    (()=> {enableDragSort('drag-sort-enable')})();
    	}
    	function removeCategory(){
		    var div = document.getElementById("main2");
		    div.removeChild(div.lastChild);

    	}
    	function downward(thisbutt){
    		var thisTable = thisbutt.parentNode.parentNode.parentNode;
		    var num = thisbutt.parentNode.parentNode.rowIndex;
		    nextRow = thisTable.rows[num+1].cells[0].lastChild.value ;
		    thisTable.rows[num+1].cells[0].lastChild.value = thisTable.rows[num].cells[0].lastChild.value;
		    thisTable.rows[num].cells[0].lastChild.value = nextRow;
    	}
    	function upward(thisbutt){
    		var thisTable = thisbutt.parentNode.parentNode.parentNode;
		    var num = thisbutt.parentNode.parentNode.rowIndex;
		    nextRow = thisTable.rows[num-1].cells[0].lastChild.value ;
		    thisTable.rows[num-1].cells[0].lastChild.value = thisTable.rows[num].cells[0].lastChild.value;
		    thisTable.rows[num].cells[0].lastChild.value = nextRow;
    	}
    	function addNo(){
			var allOut = document.querySelectorAll('table');
			for (let o = 0; o < allOut.length; o++) {
			    var outSec = document.getElementsByTagName("table")[o];
			    var outNo = [].indexOf.call(allOut , outSec );
			    for (let i = 0; i < outSec.rows.length; i++) {
			        var inSec = outSec.rows[i].cells[0].lastChild;
			        if(inSec.tagName=="TEXTAREA"){
			        	if (outSec.rows.length==1) {
			        		inSec.value = (o+1+". ")+inSec.value;
			        	}else{
			        		inSec.value = (o+1+"-"+(i+1)+". ")+inSec.value;
			        	}			                        
			        }
			    }
			}
    	}

    	function removeNo(){
			var allOut = document.querySelectorAll('table');
			for (let o = 0; o < allOut.length; o++) {
			    var outSec = document.getElementsByTagName("table")[o];
			    for (let i = 0; i < outSec.rows.length; i++) {
			        var inSec = outSec.rows[i].cells[0].lastChild;
			        if(inSec.tagName=="TEXTAREA"){
			        	if (/^\d-\d[.]\s/.test(inSec.value) == true) {
							inSec.value = inSec.value.slice(5,-1);    
						}else if(/^\d-\d[.]/.test(inSec.value) == true){
							inSec.value = inSec.value.slice(4,-1);
						}else if(/^\d[.]\s/.test(inSec.value) == true){
							inSec.value = inSec.value.slice(3,-1);
						}else if(/^\d[.]/.test(inSec.value) == true){
							inSec.value = inSec.value.slice(2,-1);
						}
			                    
			        }
			    }
			}  		
    	}

    	function addPost(thisbutt){	    

		    //num 取得table的現有欄位數+1(從0開始計算)
		    var thisTable = thisbutt.parentNode.parentNode.parentNode;
		    var num = thisbutt.parentNode.parentNode.rowIndex+1;
		    // Tr 的 .insertRow 就是在 table 欄位中新增一個 Row num 表示新增在最後一筆
		    var Tr = thisTable.insertRow(num);
		    // Td 的.insertCell 在 Tr中新增一個 td Tr.cells.length 在Tr中 Td最後欄位新增一個Td 
		    Td1 = Tr.insertCell(Tr.cells.length);
		    Td2 = Tr.insertCell(Tr.cells.length);
		    Td1.innerHTML='<textarea name="post" maxlength="1000" cols="20" rows="4" style="width: 600px; height: 35px;"></textarea>';
		    Td2.innerHTML='<button onclick="upward(this)">上移</button><button onclick="downward(this)">下移</button><button onclick="addPost(this)">新增</button><button onclick="removePost(this)">刪除</button>';
			    		
    	}

    	function removePost(thisbutt){
			var thisTable = thisbutt.parentNode.parentNode.parentNode;
		    var num = thisbutt.parentNode.parentNode.rowIndex;
		    if (thisTable.rows.length>1) {
		    	thisTable.deleteRow(num);
		    }		    
    	}

		/* Made with love by @fitri
		 This is a component of my ReactJS project
		 https://codepen.io/fitri/full/oWovYj/ */

		function enableDragSort(listClass) {
		  const sortableLists = document.getElementsByClassName(listClass);
		  Array.prototype.map.call(sortableLists, (list) => {enableDragList(list)});
		}

		function enableDragList(list) {
		  Array.prototype.map.call(list.children, (item) => {enableDragItem(item)});
		}

		function enableDragItem(item) {
			item.setAttribute('draggable', true)
			item.ondrag = handleDrag;
			item.ondragend = handleDrop;
		  
		}

		function handleDrag(item) {
		  const selectedItem = item.target,
		        list = selectedItem.parentNode,
		        x = event.clientX,
		        y = event.clientY;
		  
		  selectedItem.classList.add('drag-sort-active');
		  let swapItem = document.elementFromPoint(x, y) === null ? selectedItem : document.elementFromPoint(x, y);
		  console.log(selectedItem + "  " + swapItem);
		  if (list === swapItem.parentNode) {
		    swapItem = swapItem !== selectedItem.nextSibling ? swapItem : swapItem.nextSibling;
		    list.insertBefore(selectedItem, swapItem);
		  }
		}

		function handleDrop(item) {
		  item.target.classList.remove('drag-sort-active');
		}

		(()=> {enableDragSort('drag-sort-enable')})();	


    </script>
  </body>
</html>
