<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8">
    <title>ç¶²è·¯è¼¿æƒ…ç·¨æ’ç³»çµ± - å¤šç”¨æˆ¶ç‰ˆ</title>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e5e7eb;
        }
        .user-panel {
            background: #f3f4f6;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        .user-panel select, .user-panel input, .user-panel button {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
        }
        .user-panel button {
            background: #6366f1;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
        }
        .user-panel button:hover {
            background: #4f46e5;
            transform: translateY(-1px);
        }
        .user-panel button.delete {
            background: #ef4444;
        }
        .user-panel button.delete:hover {
            background: #dc2626;
        }
        .sync-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: #d1fae5;
            color: #065f46;
            border-radius: 20px;
            font-size: 13px;
            font-weight: bold;
        }
        .sync-dot {
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .toolbar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .toolbar button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-primary {
            background: #6366f1;
            color: white;
        }
        .btn-primary:hover {
            background: #4f46e5;
            transform: translateY(-2px);
        }
        .btn-success {
            background: #10b981;
            color: white;
        }
        .btn-success:hover {
            background: #059669;
        }
        .btn-info {
            background: #3b82f6;
            color: white;
        }
        .btn-info:hover {
            background: #2563eb;
        }
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        .btn-danger:hover {
            background: #dc2626;
        }
        .info-box {
            background: #fef3c7;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 13px;
            border-left: 4px solid #f59e0b;
        }
        .info-box strong {
            color: #92400e;
        }
        div.section {
            min-height: 5px;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 12px;
            border: 2px solid #e5e7eb;
        }
        table {
            width: 100%;
            margin-bottom: 10px;
            background: white;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            resize: vertical;
            font-family: inherit;
        }
        textarea:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        .section-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #1f2937;
        }
        #main2 { background-color: #fee2e2; }
        #main3 { background-color: #fef3c7; }
        #main4 { background-color: #dbeafe; }
        #finallcontent {
            width: 100%;
            min-height: 400px;
            padding: 15px;
            border: 2px solid #d1d5db;
            border-radius: 12px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
        .action-buttons button {
            padding: 6px 12px;
            margin-right: 5px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            font-weight: bold;
            background: #e5e7eb;
            transition: all 0.2s;
        }
        .action-buttons button:hover {
            background: #d1d5db;
        }
        .last-saved {
            font-size: 12px;
            color: #6b7280;
            margin-left: 10px;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #6b7280;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 style="margin: 0; color: #1f2937;">ğŸ“° ç¶²è·¯è¼¿æƒ…ç·¨æ’ç³»çµ±</h1>
            <div>
                <span class="sync-status" id="syncStatus" style="display: none;">
                    <span class="sync-dot"></span>
                    å·²åŒæ­¥
                </span>
                <span class="last-saved" id="lastSaved"></span>
            </div>
        </div>

        <!-- ç”¨æˆ¶ç®¡ç†é¢æ¿ -->
        <div class="user-panel">
            <label style="font-weight: bold;">ğŸ‘¤ ç”¨æˆ¶ï¼š</label>
            <select id="userSelect" onchange="switchUser()">
                <option value="">è«‹é¸æ“‡ç”¨æˆ¶</option>
            </select>
            <input type="text" id="newUserName" placeholder="æ–°ç”¨æˆ¶åç¨±" style="width: 150px;">
            <button onclick="createUser()">â• å»ºç«‹ç”¨æˆ¶</button>
            <button class="delete" onclick="deleteUser()">ğŸ—‘ï¸ åˆªé™¤ç”¨æˆ¶</button>
            
            <label style="font-weight: bold; margin-left: 20px;">â° æ™‚æ®µï¼š</label>
            <select id="hour" onchange="switchTimeSlot()">
                <option value="10">10</option>
                <option value="11">11</option>
                <option value="12">12</option>
                <option value="14">14</option>
                <option value="15">15</option>
                <option value="16">16</option>
                <option value="17">17</option>
                <option value="18">18</option>
            </select>
        </div>

        <!-- æç¤ºè¨Šæ¯ -->
        <div class="info-box">
            ğŸ’¡ <strong>åˆä½µåŠŸèƒ½èªªæ˜ï¼š</strong><br>
            â€¢ <strong>14 æ™‚</strong>ï¼šå¯åˆä½µ 11+12+14 æ™‚çš„æ–°è<br>
            â€¢ <strong>18 æ™‚</strong>ï¼šå¯åˆä½µ 15+16+17+18 æ™‚çš„æ–°è<br>
            â€¢ <strong>âš ï¸ æ¯å¤©ç¬¬ä¸€æ¬¡æ‰“é–‹ç³»çµ±æœƒè‡ªå‹•æ¸…é™¤æ˜¨å¤©çš„è³‡æ–™</strong>
        </div>

        <!-- å·¥å…·åˆ— -->
        <div class="toolbar">
            <button class="btn-primary" onclick="addNo()">ğŸ“ è‡ªå‹•ç·¨è™Ÿ</button>
            <button class="btn-primary" onclick="removeNo()">ğŸ”„ ç§»é™¤ç·¨è™Ÿ</button>
            <button class="btn-success" onclick="manualSave()">ğŸ’¾ æ‰‹å‹•å„²å­˜</button>
            <button class="btn-info" onclick="mergeTimeSlots()">ğŸ”€ åˆä½µæ™‚æ®µ</button>
        </div>

        <p class="section-title">ğŸ›ï¸ å¸‚æ”¿</p>
        <div id="main2" class="section drag-sort-enable">
            <table>
                <tbody>
                    <tr>
                        <td><textarea name="post" style="height: 35px;" oninput="autogrow(this)"></textarea></td>
                        <td class="action-buttons" onmouseover="dragReady(this)" onmouseleave="dragStop(this)">
                            <button onclick="addPost(this)">æ–°å¢</button>
                            <button onclick="removePost(this)">åˆªé™¤</button>
                            <button>ç§»å‹•</button>
                            <button onclick="combine(this)">åˆä½µ</button>
                        </td>
                    </tr>
                </tbody>
            </table>
            <table>
                <tbody>
                    <tr>
                        <td><textarea name="post" style="height: 35px;" oninput="autogrow(this)"></textarea></td>
                        <td class="action-buttons" onmouseover="dragReady(this)" onmouseleave="dragStop(this)">
                            <button onclick="addPost(this)">æ–°å¢</button>
                            <button onclick="removePost(this)">åˆªé™¤</button>
                            <button>ç§»å‹•</button>
                            <button onclick="combine(this)">åˆä½µ</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <p class="section-title">â­ é‡é»</p>
        <div id="main3" class="section drag-sort-enable">
            <table>
                <tbody>
                    <tr>
                        <td><textarea name="post" style="height: 35px;" oninput="autogrow(this)"></textarea></td>
                        <td class="action-buttons" onmouseover="dragReady(this)" onmouseleave="dragStop(this)">
                            <button onclick="addPost(this)">æ–°å¢</button>
                            <button onclick="removePost(this)">åˆªé™¤</button>
                            <button>ç§»å‹•</button>
                            <button onclick="combine(this)">åˆä½µ</button>
                        </td>
                    </tr>
                </tbody>
            </table>
            <table>
                <tbody>
                    <tr>
                        <td><textarea name="post" style="height: 35px;" oninput="autogrow(this)"></textarea></td>
                        <td class="action-buttons" onmouseover="dragReady(this)" onmouseleave="dragStop(this)">
                            <button onclick="addPost(this)">æ–°å¢</button>
                            <button onclick="removePost(this)">åˆªé™¤</button>
                            <button>ç§»å‹•</button>
                            <button onclick="combine(this)">åˆä½µ</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <p class="section-title">ğŸ“± ç¤¾ç¾¤</p>
        <div id="main4" class="section drag-sort-enable">
            <table>
                <tbody>
                    <tr>
                        <td><textarea name="post" style="height: 35px;" oninput="autogrow(this)"></textarea></td>
                        <td class="action-buttons" onmouseover="dragReady(this)" onmouseleave="dragStop(this)">
                            <button onclick="addPost(this)">æ–°å¢</button>
                            <button onclick="removePost(this)">åˆªé™¤</button>
                            <button>ç§»å‹•</button>
                            <button onclick="combine(this)">åˆä½µ</button>
                        </td>
                    </tr>
                </tbody>
            </table>
            <table>
                <tbody>
                    <tr>
                        <td><textarea name="post" style="height: 35px;" oninput="autogrow(this)"></textarea></td>
                        <td class="action-buttons" onmouseover="dragReady(this)" onmouseleave="dragStop(this)">
                            <button onclick="addPost(this)">æ–°å¢</button>
                            <button onclick="removePost(this)">åˆªé™¤</button>
                            <button>ç§»å‹•</button>
                            <button onclick="combine(this)">åˆä½µ</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <p class="section-title">ğŸ“„ æœ€çµ‚å ±è¡¨</p>
        <textarea id="finallcontent"></textarea>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, doc, setDoc, getDoc, collection, getDocs, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDy1B1ilbJ9j5r2yzmEpHmUif4ag6zqafM",
            authDomain: "news-arrange-system.firebaseapp.com",
            projectId: "news-arrange-system",
            storageBucket: "news-arrange-system.firebasestorage.app",
            messagingSenderId: "322470991030",
            appId: "1:322470991030:web:530e201c0b7b7b66108217"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        window.firebaseDB = db;
        window.firebaseDoc = doc;
        window.firebaseSetDoc = setDoc;
        window.firebaseGetDoc = getDoc;
        window.firebaseCollection = collection;
        window.firebaseGetDocs = getDocs;
        window.firebaseDeleteDoc = deleteDoc;
        
        console.log('âœ… Firebase å·²åˆå§‹åŒ– (news-arrange-system)');
    </script>

    <script>
        let currentUser = '';
        let currentHour = '10';
        let autoSaveInterval;
        let isUpdating = false;

        // âœ… å–å¾—ä»Šå¤©çš„æ—¥æœŸå­—ä¸²
        function getTodayDateString() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // âœ… æª¢æŸ¥ä¸¦æ¸…é™¤èˆŠè³‡æ–™
        async function checkAndClearOldData() {
            if (!currentUser || !window.firebaseDB) return;
            
            try {
                const userDoc = window.firebaseDoc(window.firebaseDB, 'newsUsers', currentUser);
                const docSnap = await window.firebaseGetDoc(userDoc);
                
                if (!docSnap.exists()) return;
                
                const userData = docSnap.data();
                const today = getTodayDateString();
                
                // æª¢æŸ¥æ˜¯å¦æœ‰å„²å­˜çš„æ—¥æœŸ
                if (userData.lastClearDate === today) {
                    // ä»Šå¤©å·²ç¶“æ¸…é™¤éäº†
                    console.log('âœ… ä»Šå¤©çš„è³‡æ–™å·²æ˜¯æœ€æ–°');
                    return;
                }
                
                // æ¸…é™¤æ‰€æœ‰æ™‚æ®µçš„è³‡æ–™
                console.log('ğŸ—‘ï¸ æ¸…é™¤æ˜¨å¤©çš„è³‡æ–™...');
                userData.timeSlots = {};
                userData.lastClearDate = today;
                
                await window.firebaseSetDoc(userDoc, userData);
                console.log('âœ… å·²æ¸…é™¤èˆŠè³‡æ–™ï¼Œæº–å‚™é–‹å§‹æ–°çš„ä¸€å¤©ï¼');
                
                // æ¸…ç©ºç•«é¢
                clearAllContent();
                
                // é¡¯ç¤ºæç¤º
                alert('ğŸŒ… æ–°çš„ä¸€å¤©é–‹å§‹äº†ï¼\næ˜¨å¤©çš„è³‡æ–™å·²è‡ªå‹•æ¸…é™¤ã€‚');
                
            } catch (error) {
                console.error('âŒ æ¸…é™¤èˆŠè³‡æ–™å¤±æ•—:', error);
            }
        }

        // åˆå§‹åŒ–
        window.addEventListener('load', async () => {
            await loadUsers();
            startAutoSave();
            
            // âœ… æ¯å°æ™‚æª¢æŸ¥ä¸€æ¬¡æ˜¯å¦éœ€è¦æ¸…é™¤
            setInterval(async () => {
                if (currentUser) {
                    await checkAndClearOldData();
                }
            }, 60 * 60 * 1000); // æ¯å°æ™‚æª¢æŸ¥ä¸€æ¬¡
        });

        // è¼‰å…¥ç”¨æˆ¶åˆ—è¡¨
        async function loadUsers() {
            if (!window.firebaseDB) return;
            
            try {
                const usersCol = window.firebaseCollection(window.firebaseDB, 'newsUsers');
                const snapshot = await window.firebaseGetDocs(usersCol);
                
                const userSelect = document.getElementById('userSelect');
                userSelect.innerHTML = '<option value="">è«‹é¸æ“‡ç”¨æˆ¶</option>';
                
                snapshot.forEach(doc => {
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = doc.id;
                    userSelect.appendChild(option);
                });
                
                console.log(`âœ… è¼‰å…¥ ${snapshot.size} å€‹ç”¨æˆ¶`);
            } catch (error) {
                console.error('âŒ è¼‰å…¥ç”¨æˆ¶å¤±æ•—:', error);
            }
        }

        // å»ºç«‹æ–°ç”¨æˆ¶
        async function createUser() {
            const userName = document.getElementById('newUserName').value.trim();
            if (!userName) {
                alert('è«‹è¼¸å…¥ç”¨æˆ¶åç¨±ï¼');
                return;
            }
            
            if (!window.firebaseDB) {
                alert('Firebase æœªåˆå§‹åŒ–ï¼');
                return;
            }
            
            try {
                const userDoc = window.firebaseDoc(window.firebaseDB, 'newsUsers', userName);
                await window.firebaseSetDoc(userDoc, {
                    createdAt: new Date(),
                    timeSlots: {},
                    lastClearDate: getTodayDateString()
                });
                
                alert(`âœ… ç”¨æˆ¶ã€Œ${userName}ã€å»ºç«‹æˆåŠŸï¼`);
                document.getElementById('newUserName').value = '';
                await loadUsers();
                
                // è‡ªå‹•åˆ‡æ›åˆ°æ–°ç”¨æˆ¶
                document.getElementById('userSelect').value = userName;
                switchUser();
            } catch (error) {
                console.error('âŒ å»ºç«‹ç”¨æˆ¶å¤±æ•—:', error);
                alert('å»ºç«‹ç”¨æˆ¶å¤±æ•—ï¼š' + error.message);
            }
        }

        // åˆªé™¤ç”¨æˆ¶
        async function deleteUser() {
            const userName = document.getElementById('userSelect').value;
            if (!userName) {
                alert('è«‹å…ˆé¸æ“‡è¦åˆªé™¤çš„ç”¨æˆ¶ï¼');
                return;
            }
            
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤ç”¨æˆ¶ã€Œ${userName}ã€å—ï¼Ÿ\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼`)) {
                return;
            }
            
            try {
                const userDoc = window.firebaseDoc(window.firebaseDB, 'newsUsers', userName);
                await window.firebaseDeleteDoc(userDoc);
                
                alert(`âœ… ç”¨æˆ¶ã€Œ${userName}ã€å·²åˆªé™¤ï¼`);
                currentUser = '';
                await loadUsers();
                clearAllContent();
            } catch (error) {
                console.error('âŒ åˆªé™¤ç”¨æˆ¶å¤±æ•—:', error);
                alert('åˆªé™¤ç”¨æˆ¶å¤±æ•—ï¼š' + error.message);
            }
        }

        // åˆ‡æ›ç”¨æˆ¶
        async function switchUser() {
            const userName = document.getElementById('userSelect').value;
            if (!userName) {
                currentUser = '';
                clearAllContent();
                return;
            }
            
            currentUser = userName;
            
            // âœ… å…ˆæª¢æŸ¥ä¸¦æ¸…é™¤èˆŠè³‡æ–™
            await checkAndClearOldData();
            
            // å†è¼‰å…¥å…§å®¹
            await loadContent();
        }

        // åˆ‡æ›æ™‚æ®µ
        function switchTimeSlot() {
            currentHour = document.getElementById('hour').value;
            if (currentUser) {
                loadContent();
            }
        }

        // æ‰‹å‹•å„²å­˜
        async function manualSave() {
            if (!currentUser) {
                alert('è«‹å…ˆé¸æ“‡ç”¨æˆ¶ï¼');
                return;
            }
            
            await saveContent();
            alert('âœ… å„²å­˜æˆåŠŸï¼');
        }

        // å„²å­˜å…§å®¹åˆ° Firebase
        async function saveContent() {
            if (!currentUser || !window.firebaseDB || isUpdating) return;
            
            try {
                const contentData = {
                    sections: []
                };
                
                // ç²å–æ‰€æœ‰å€å¡Šçš„å…§å®¹
                const sections = document.getElementsByClassName('drag-sort-enable');
                for (let i = 0; i < sections.length; i++) {
                    const sectionData = {
                        id: sections[i].id,
                        posts: []
                    };
                    
                    const textareas = sections[i].getElementsByTagName('textarea');
                    for (let j = 0; j < textareas.length; j++) {
                        sectionData.posts.push(textareas[j].value);
                    }
                    
                    contentData.sections.push(sectionData);
                }
                
                // å„²å­˜åˆ° Firebase
                const userDoc = window.firebaseDoc(window.firebaseDB, 'newsUsers', currentUser);
                const docSnap = await window.firebaseGetDoc(userDoc);
                const userData = docSnap.exists() ? docSnap.data() : {};
                
                if (!userData.timeSlots) {
                    userData.timeSlots = {};
                }
                
                userData.timeSlots[currentHour] = {
                    content: contentData,
                    lastUpdated: new Date()
                };
                
                // âœ… è¨˜éŒ„ä»Šå¤©çš„æ—¥æœŸ
                userData.lastClearDate = getTodayDateString();
                
                await window.firebaseSetDoc(userDoc, userData);
                
                document.getElementById('syncStatus').style.display = 'inline-flex';
                document.getElementById('lastSaved').textContent = `æœ€å¾Œå„²å­˜ï¼š${new Date().toLocaleTimeString('zh-TW')}`;
                
                console.log(`âœ… å·²å„²å­˜ ${currentUser} - ${currentHour}æ™‚`);
            } catch (error) {
                console.error('âŒ å„²å­˜å¤±æ•—:', error);
                alert('å„²å­˜å¤±æ•—ï¼š' + error.message);
            }
        }

        // è®€å–å…§å®¹
        async function loadContent() {
            if (!currentUser || !window.firebaseDB) return;
            
            isUpdating = true;
            
            try {
                const userDoc = window.firebaseDoc(window.firebaseDB, 'newsUsers', currentUser);
                const docSnap = await window.firebaseGetDoc(userDoc);
                
                if (!docSnap.exists()) {
                    console.log('ğŸ“ ç”¨æˆ¶è³‡æ–™ä¸å­˜åœ¨');
                    clearAllContent();
                    isUpdating = false;
                    return;
                }
                
                const userData = docSnap.data();
                const timeSlotData = userData.timeSlots?.[currentHour];
                
                if (!timeSlotData) {
                    console.log(`ğŸ“ æ™‚æ®µ ${currentHour} ç„¡è³‡æ–™`);
                    clearAllContent();
                    isUpdating = false;
                    return;
                }
                
                const contentData = timeSlotData.content;
                
                // æ¢å¾©å„å€å¡Šå…§å®¹
                contentData.sections.forEach(section => {
                    const sectionElement = document.getElementById(section.id);
                    if (sectionElement) {
                        // æ¸…ç©ºç¾æœ‰å…§å®¹
                        while (sectionElement.firstChild) {
                            sectionElement.removeChild(sectionElement.firstChild);
                        }
                        
                        // âœ… ç¢ºä¿è‡³å°‘æœ‰å…©å€‹è¼¸å…¥æ¡†
                        const postsToRender = section.posts.length > 0 ? section.posts : ['', ''];
                        
                        // é‡å»ºå…§å®¹
                        postsToRender.forEach(post => {
                            const table = document.createElement('table');
                            const tr = table.insertRow(0);
                            const td1 = tr.insertCell(0);
                            const td2 = tr.insertCell(1);
                            
                            td2.className = 'action-buttons';
                            td2.setAttribute('onmouseover', 'dragReady(this)');
                            td2.setAttribute('onmouseleave', 'dragStop(this)');
                            
                            td1.innerHTML = `<textarea name="post" style="height: 35px;" oninput="autogrow(this)">${post}</textarea>`;
                            td2.innerHTML = '<button onclick="addPost(this)">æ–°å¢</button><button onclick="removePost(this)">åˆªé™¤</button><button>ç§»å‹•</button><button onclick="combine(this)">åˆä½µ</button>';
                            
                            sectionElement.appendChild(table);
                            
                            // è‡ªå‹•èª¿æ•´é«˜åº¦
                            const textarea = td1.querySelector('textarea');
                            autogrow(textarea);
                        });
                    }
                });
                
                enableDragSort('drag-sort-enable');
                
                const lastUpdate = timeSlotData.lastUpdated?.toDate?.() || new Date(timeSlotData.lastUpdated);
                document.getElementById('lastSaved').textContent = `æœ€å¾Œå„²å­˜ï¼š${lastUpdate.toLocaleString('zh-TW')}`;
                document.getElementById('syncStatus').style.display = 'inline-flex';
                
                console.log(`âœ… å·²è¼‰å…¥ ${currentUser} - ${currentHour}æ™‚`);
            } catch (error) {
                console.error('âŒ è®€å–å¤±æ•—:', error);
                alert('è®€å–å¤±æ•—ï¼š' + error.message);
            }
            
            isUpdating = false;
        }

        // åˆä½µæ™‚æ®µåŠŸèƒ½
        async function mergeTimeSlots() {
            if (!currentUser) {
                alert('è«‹å…ˆé¸æ“‡ç”¨æˆ¶ï¼');
                return;
            }
            
            const currentHourNum = parseInt(currentHour);
            let timeSlotsToMerge = [];
            let targetHour = '';
            
            // åˆ¤æ–·è¦åˆä½µå“ªäº›æ™‚æ®µ
            if (currentHourNum === 14) {
                timeSlotsToMerge = ['11', '12', '14'];
                targetHour = '14';
            } else if (currentHourNum === 18) {
                timeSlotsToMerge = ['15', '16', '17', '18'];
                targetHour = '18';
            } else {
                alert('âš ï¸ åªèƒ½åœ¨ 14 æ™‚æˆ– 18 æ™‚ä½¿ç”¨åˆä½µåŠŸèƒ½ï¼\n\n14 æ™‚ï¼šåˆä½µ 11+12+14\n18 æ™‚ï¼šåˆä½µ 15+16+17+18');
                return;
            }
            
            if (!confirm(`ç¢ºå®šè¦åˆä½µ ${timeSlotsToMerge.join('ã€')} æ™‚çš„æ–°èå—ï¼Ÿ\n\nå°‡æœƒè¦†è“‹ç›®å‰ ${targetHour} æ™‚çš„å…§å®¹ï¼`)) {
                return;
            }
            
            try {
                // è®€å–ç”¨æˆ¶è³‡æ–™
                const userDoc = window.firebaseDoc(window.firebaseDB, 'newsUsers', currentUser);
                const docSnap = await window.firebaseGetDoc(userDoc);
                
                if (!docSnap.exists()) {
                    alert('æ‰¾ä¸åˆ°ç”¨æˆ¶è³‡æ–™ï¼');
                    return;
                }
                
                const userData = docSnap.data();
                const mergedContent = {
                    sections: [
                        { id: 'main2', posts: [] }, // å¸‚æ”¿
                        { id: 'main3', posts: [] }, // é‡é»
                        { id: 'main4', posts: [] }  // ç¤¾ç¾¤
                    ]
                };
                
                // åˆä½µå„æ™‚æ®µçš„å…§å®¹
                timeSlotsToMerge.forEach(hour => {
                    const timeSlotData = userData.timeSlots?.[hour];
                    if (timeSlotData && timeSlotData.content) {
                        timeSlotData.content.sections.forEach((section, index) => {
                            section.posts.forEach(post => {
                                // ç§»é™¤ç·¨è™Ÿ
                                const cleanPost = removeNumbering(post);
                                if (cleanPost.trim()) {
                                    mergedContent.sections[index].posts.push(cleanPost);
                                }
                            });
                        });
                    }
                });
                
                // âœ… ç¢ºä¿æ¯å€‹å€å¡Šè‡³å°‘æœ‰å…©å€‹è¼¸å…¥æ¡†
                mergedContent.sections.forEach(section => {
                    if (section.posts.length === 0) {
                        section.posts = ['', ''];
                    } else if (section.posts.length === 1) {
                        section.posts.push('');
                    }
                });
                
                // æ›´æ–°ç•«é¢
                mergedContent.sections.forEach((section, index) => {
                    const sectionElement = document.getElementById(section.id);
                    if (sectionElement) {
                        // æ¸…ç©ºç¾æœ‰å…§å®¹
                        while (sectionElement.firstChild) {
                            sectionElement.removeChild(sectionElement.firstChild);
                        }
                        
                        // é‡å»ºå…§å®¹
                        section.posts.forEach(post => {
                            const table = document.createElement('table');
                            const tr = table.insertRow(0);
                            const td1 = tr.insertCell(0);
                            const td2 = tr.insertCell(1);
                            
                            td2.className = 'action-buttons';
                            td2.setAttribute('onmouseover', 'dragReady(this)');
                            td2.setAttribute('onmouseleave', 'dragStop(this)');
                            
                            td1.innerHTML = `<textarea name="post" style="height: 35px;" oninput="autogrow(this)">${post}</textarea>`;
                            td2.innerHTML = '<button onclick="addPost(this)">æ–°å¢</button><button onclick="removePost(this)">åˆªé™¤</button><button>ç§»å‹•</button><button onclick="combine(this)">åˆä½µ</button>';
                            
                            sectionElement.appendChild(table);
                            
                            // è‡ªå‹•èª¿æ•´é«˜åº¦
                            const textarea = td1.querySelector('textarea');
                            autogrow(textarea);
                        });
                    }
                });
                
                enableDragSort('drag-sort-enable');
                
                // è¨ˆç®—å¯¦éš›æœ‰å…§å®¹çš„æ–°èæ•¸é‡ï¼ˆä¸å«ç©ºç™½ï¼‰
                const actualCounts = mergedContent.sections.map(section => 
                    section.posts.filter(post => post.trim()).length
                );
                
                alert(`âœ… å·²åˆä½µ ${timeSlotsToMerge.join('ã€')} æ™‚çš„æ–°èï¼\n\nå¸‚æ”¿ï¼š${actualCounts[0]} å‰‡\né‡é»ï¼š${actualCounts[1]} å‰‡\nç¤¾ç¾¤ï¼š${actualCounts[2]} å‰‡\n\nè¨˜å¾—é»æ“Šã€Œæ‰‹å‹•å„²å­˜ã€ï¼`);
                
                document.getElementById('syncStatus').style.display = 'none';
                
            } catch (error) {
                console.error('âŒ åˆä½µå¤±æ•—:', error);
                alert('åˆä½µå¤±æ•—ï¼š' + error.message);
            }
        }

        // ç§»é™¤ç·¨è™Ÿçš„è¼”åŠ©å‡½æ•¸
        function removeNumbering(text) {
            let textslice = text.split("http");
            let newContent = "";

            for (let i = 0; i < textslice.length - 1; i++) {
                if (/\d+-\d+[.]\s/.test(textslice[i])) {
                    let noStart = textslice[i].search(/\d+-\d+[.]\s/);
                    let tStart = textslice[i].match(/\d+-\d+[.]\s/)[0].length;
                    newContent += textslice[i].slice(0, noStart) + textslice[i].slice(noStart + tStart) + "http";
                } else if (/(\n\d-+)|(^\d+-+)\d+[.].+[^\n].+[(].*[)]\n/.test(textslice[i])) {
                    let noStart = textslice[i].search(/\d+-\d+[.]/);
                    let tStart = textslice[i].match(/\d+-\d+[.]/)[0].length;
                    newContent += textslice[i].slice(0, noStart) + textslice[i].slice(noStart + tStart) + "http";
                } else if (/\d+[.]\s/.test(textslice[i])) {
                    let noStart = textslice[i].search(/\d+[.]\s/);
                    let tStart = textslice[i].match(/\d+[.]\s/)[0].length;
                    newContent += textslice[i].slice(0, noStart) + textslice[i].slice(noStart + tStart) + "http";
                } else if (/(\n\d)|^\d+[.].*[^\n].*[(].*[)]\n/.test(textslice[i])) {
                    let noStart = textslice[i].search(/\d+[.]/);
                    let tStart = textslice[i].match(/\d+[.]/)[0].length;
                    newContent += textslice[i].slice(0, noStart) + textslice[i].slice(noStart + tStart) + "http";
                } else {
                    newContent += textslice[i] + "http";
                }
            }

            newContent += textslice[textslice.length - 1];
            return newContent;
        }

        // æ¸…ç©ºæ‰€æœ‰å…§å®¹
        function clearAllContent() {
            const sections = document.getElementsByClassName('drag-sort-enable');
            for (let i = 0; i < sections.length; i++) {
                while (sections[i].firstChild) {
                    sections[i].removeChild(sections[i].firstChild);
                }
                
                // âœ… ç¢ºä¿è‡³å°‘æœ‰å…©å€‹ç©ºç™½è¡¨æ ¼
                for (let j = 0; j < 2; j++) {
                    const table = document.createElement('table');
                    const tr = table.insertRow(0);
                    const td1 = tr.insertCell(0);
                    const td2 = tr.insertCell(1);
                    
                    td2.className = 'action-buttons';
                    td2.setAttribute('onmouseover', 'dragReady(this)');
                    td2.setAttribute('onmouseleave', 'dragStop(this)');
                    
                    td1.innerHTML = '<textarea name="post" style="height: 35px;" oninput="autogrow(this)"></textarea>';
                    td2.innerHTML = '<button onclick="addPost(this)">æ–°å¢</button><button onclick="removePost(this)">åˆªé™¤</button><button>ç§»å‹•</button><button onclick="combine(this)">åˆä½µ</button>';
                    
                    sections[i].appendChild(table);
                }
            }
            
            enableDragSort('drag-sort-enable');
            
            document.getElementById('finallcontent').value = '';
            document.getElementById('lastSaved').textContent = '';
            document.getElementById('syncStatus').style.display = 'none';
        }

        // è‡ªå‹•å„²å­˜ï¼ˆæ¯ 5 åˆ†é˜ï¼‰
        function startAutoSave() {
            autoSaveInterval = setInterval(() => {
                if (currentUser) {
                    saveContent();
                    console.log('ğŸ”„ è‡ªå‹•å„²å­˜å®Œæˆ');
                }
            }, 5 * 60 * 1000); // 5 åˆ†é˜
        }

        // ä»¥ä¸‹æ˜¯åŸæœ‰åŠŸèƒ½
        var divArray = document.getElementsByClassName('drag-sort-enable');
        var day = new Date().getDate();

        function combine(thisbutt) {
            var text = thisbutt.parentNode.parentNode.cells[0].lastChild;
            var combineBefore = text.value;
            var eachone = combineBefore.split("http");
            var bracketsleft = new RegExp(/[(].*[)]/);
            var bracketsright = new RegExp(/[)]\n/);
            var combineAfter = combineBefore.split("\n\n")[0].slice(0, eachone[0].search(bracketsright));

            for (let index = 1; index < eachone.length - 1; index++) {
                var start = eachone[index].search(bracketsleft);
                var end = eachone[index].search(bracketsright);
                eachone[index] = eachone[index].slice(start + 1, end);
                combineAfter += "ã€" + eachone[index];
            }
            combineAfter += combineBefore.split("\n\n")[0].slice(eachone[0].search(bracketsright));
            text.value = combineAfter;
        }

        function autogrow(text) {
            var adjustedHeight = text.clientHeight;
            adjustedHeight = Math.max(text.scrollHeight, adjustedHeight);
            if (adjustedHeight > text.clientHeight) {
                text.style.height = adjustedHeight + 'px';
            }
        }

        function addNo() {
            var rules = new RegExp(/[^\n].*[(].*[)]\n/);
            var hour = document.getElementById('hour').value;

            for (var d = 0; d < divArray.length; d++) {
                allTextarea = divArray[d].getElementsByTagName("textarea");
                for (let o = 0; o < allTextarea.length; o++) {
                    var textslice = allTextarea[o].value.split("http");
                    var newContent = "";
                    if (textslice.length > 2) {
                        newContent += (o + 1) + "-1. ";
                        newContent += textslice[0] + "http";
                    } else if (textslice.length > 1) {
                        newContent += (o + 1) + ". ";
                        newContent += textslice[0] + "http";
                    }

                    for (let i = 1; i < textslice.length - 1; i++) {
                        titleStart = textslice[i].search(rules);
                        newContent += textslice[i].slice(0, titleStart) + (o + 1) + "-" + (i + 1) + ". " + textslice[i].slice(titleStart) + "http";
                    }
                    if (textslice[textslice.length - 1].search('\n') > -1) {
                        newContent += textslice[textslice.length - 1].slice(0, textslice[textslice.length - 1].search('\n'));
                    } else {
                        newContent += textslice[textslice.length - 1];
                    }

                    allTextarea[o].value = newContent;
                }
            }
            
            // è‡ªå‹•ç”Ÿæˆå ±è¡¨
            var descriptionArray = new Array(3);
            descriptionArray[0] = "ä»Š(" + day + ")æ—¥" + hour + "æ™‚æ–°åŒ—å¸‚æ”¿åºœå¸‚æ”¿æ–°èå½™æ•´\n\næ–°èå±€ æ–°èè¯ç¹«ç§‘ æ•¬å•Ÿ\n\n----------------------------------------------\nå¸‚æ”¿è¼¿æƒ…ï¼Œå¦‚ä¸‹ï¼š\n\n";
            descriptionArray[1] = "ä»Š(" + day + ")æ—¥" + hour + "æ™‚æ–°åŒ—å¸‚æ”¿åºœé‡é»æ–°èå½™æ•´\n\næ–°èå±€ æ–°èè¯ç¹«ç§‘ æ•¬å•Ÿ\n-----------------------------------------------\n\n";
            descriptionArray[2] = "ä»Š(" + day + ")æ—¥" + hour + "æ™‚æ–°åŒ—å¸‚æ”¿åºœç¤¾ç¾¤æ–°èå½™æ•´\n\næ–°èå±€ æ–°èè¯ç¹«ç§‘ æ•¬å•Ÿ\n----------------------------------------------\n\n";

            var finalltext = document.getElementById("finallcontent");
            finalltext.value = "";
            for (var des = 0; des < 3; des++) {
                finalltext.value += descriptionArray[des];
                var allthiscontent = divArray[des].getElementsByTagName("textarea");
                for (let con = 0; con < allthiscontent.length; con++) {
                    if (allthiscontent[con].value.trim()) {
                        finalltext.value += allthiscontent[con].value + "\n\n";
                    }
                }
            }
            autogrow(finalltext);
        }

        function removeNo() {
            var rules = new RegExp(/[^\n].*[(].*[)]\n/);
            allTextarea = document.getElementsByName("post");
            for (let o = 0; o < allTextarea.length; o++) {
                var textslice = allTextarea[o].value.split("http");
                var newContent = "";

                for (let i = 0; i < textslice.length - 1; i++) {
                    if (/\d+-\d+[.]\s/.test(textslice[i]) == true) {
                        noStart = textslice[i].search(/\d+-\d+[.]\s/);
                        tStart = textslice[i].match(/\d+-\d+[.]\s/)[0].length;
                        newContent += textslice[i].slice(0, noStart) + textslice[i].slice(noStart + tStart) + "http";
                    } else if (/(\n\d-+)|(^\d+-+)\d+[.].+[^\n].+[(].*[)]\n/.test(textslice[i]) == true) {
                        noStart = textslice[i].search(/\d+-\d+[.]/);
                        tStart = textslice[i].match(/\d+-\d+[.]/)[0].length;
                        newContent += textslice[i].slice(0, noStart) + textslice[i].slice(noStart + tStart) + "http";
                    } else if (/\d+[.]\s/.test(textslice[i]) == true) {
                        noStart = textslice[i].search(/\d+[.]\s/);
                        tStart = textslice[i].match(/\d+[.]\s/)[0].length;
                        newContent += textslice[i].slice(0, noStart) + textslice[i].slice(noStart + tStart) + "http";
                    } else if (/(\n\d)|^\d+[.].*[^\n].*[(].*[)]\n/.test(textslice[i]) == true) {
                        noStart = textslice[i].search(/\d+[.]/);
                        tStart = textslice[i].match(/\d+[.]/)[0].length;
                        newContent += textslice[i].slice(0, noStart) + textslice[i].slice(noStart + tStart) + "http";
                    } else {
                        newContent += textslice[i] + "http";
                    }
                }

                newContent += textslice[textslice.length - 1];
                allTextarea[o].value = newContent;
            }
        }

        function addPost(thisbutt) {
            var thisTable = document.createElement("table");
            var Tr = thisTable.insertRow(0);
            Td1 = Tr.insertCell(Tr.cells.length);
            Td2 = Tr.insertCell(Tr.cells.length);
            Td2.className = 'action-buttons';
            Td2.setAttribute('onmouseover', "dragReady(this)");
            Td2.setAttribute('onmouseleave', "dragStop(this)");
            Td1.innerHTML = '<textarea name="post" style="height: 35px;" oninput="autogrow(this)"></textarea>';
            Td2.innerHTML = '<button onclick="addPost(this)">æ–°å¢</button><button onclick="removePost(this)">åˆªé™¤</button><button>ç§»å‹•</button><button onclick="combine(this)">åˆä½µ</button>';
            var div = thisbutt.parentNode.parentNode.parentNode.parentNode.parentNode;
            div.insertBefore(thisTable, thisbutt.parentNode.parentNode.parentNode.parentNode.nextSibling);
            (() => { enableDragSort('drag-sort-enable') })();
        }

        function removePost(thisbutt) {
            var div = thisbutt.parentNode.parentNode.parentNode.parentNode.parentNode;
            
            // âœ… ç¢ºä¿è‡³å°‘ä¿ç•™ä¸€å€‹è¼¸å…¥æ¡†
            if (div.children.length <= 1) {
                alert('âš ï¸ è‡³å°‘è¦ä¿ç•™ä¸€å€‹è¼¸å…¥æ¡†ï¼');
                return;
            }
            
            div.removeChild(thisbutt.parentNode.parentNode.parentNode.parentNode);
        }

        function enableDragSort(listClass) {
            const sortableLists = document.getElementsByClassName(listClass);
            Array.prototype.map.call(sortableLists, (list) => { enableDragList(list) });
        }

        function enableDragList(list) {
            Array.prototype.map.call(list.children, (item) => { enableDragItem(item) });
        }

        function enableDragItem(item) {
            item.ondrag = handleDrag;
            item.ondragend = handleDrop;
        }

        function handleDrag(item) {
            const selectedItem = item.target,
                list = selectedItem.parentNode,
                x = event.clientX,
                y = event.clientY;

            selectedItem.classList.add('drag-sort-active');
            let swapItem = document.elementFromPoint(x, y) === null ? selectedItem : document.elementFromPoint(x, y);
            if (list === swapItem.parentNode) {
                swapItem = swapItem !== selectedItem.nextSibling ? swapItem : swapItem.nextSibling;
                list.insertBefore(selectedItem, swapItem);
            }
        }

        function handleDrop(item) {
            item.target.classList.remove('drag-sort-active');
        }

        (() => { enableDragSort('drag-sort-enable') })();

        function dragReady(d) {
            var dragdiv = d.parentNode.parentNode.parentNode.parentNode;
            for (var o = 0; o < dragdiv.children.length; o++) {
                dragdiv.children[o].setAttribute('draggable', true);
            }
        }

        function dragStop(d) {
            var dragdiv = d.parentNode.parentNode.parentNode.parentNode;
            for (var o = 0; o < dragdiv.children.length; o++) {
                dragdiv.children[o].setAttribute('draggable', false);
            }
        }

        // ç›£è½å…§å®¹è®Šæ›´
        document.addEventListener('input', (e) => {
            if (e.target.tagName === 'TEXTAREA' && currentUser) {
                document.getElementById('syncStatus').style.display = 'none';
            }
        });
    </script>
</body>
</html>
